version: '1.0'

steps:
  main_clone:
    type: git-clone
    repo: ${{REPO_OWNER}}/${{REPO_NAME}}
    git: ${{GIT_CONTEXT}}
    revision: ${{ONPREM_MASTER_BRANCH}}

  update_deps:
    image: alpine/helm:3.2.1
    commands:
      - helm repo add codefresh http://chartmuseum.codefresh.io
      - helm repo add codefresh-dev http://chartmuseum-dev.codefresh.io
      - helm dependency update --skip-refresh --debug codefresh

  update_onprem:
    image: codefreshio/ci-helpers
    commands:
      - export GITHUB_TOKEN=$(codefresh get contexts --type git.github ${GIT_CONTEXT} --decrypt -o json | jq -r '.spec.data.auth.password') || return 1
      - ./update_onprem.sh