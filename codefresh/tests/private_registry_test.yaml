# yaml-language-server: $schema=https://raw.githubusercontent.com/quintush/helm-unittest/master/schema/helm-testsuite.json
suite: test private registry prefix in subcharts
templates:
  - charts/cfapi/templates/controller.yaml
  - charts/cfapi/templates/secrets.yaml
  - charts/cfui/templates/deployment.yaml
  - charts/charts-manager/templates/controller.yaml
  - charts/charts-manager/templates/secrets.yaml
  - charts/cluster-providers/templates/controller.yaml
  - charts/cluster-providers/templates/secrets.yaml
  - charts/context-manager/templates/controller.yaml
  - charts/context-manager/templates/secrets.yaml
  - charts/gitops-dashboard-manager/templates/controller.yaml
  - charts/gitops-dashboard-manager/templates/secrets.yaml
  - charts/helm-repo-manager/templates/controller.yaml
  - charts/k8s-monitor/templates/controller.yaml
  - charts/k8s-monitor/templates/secrets.yaml
  - charts/kube-integration/templates/controller.yaml
  - charts/kube-integration/templates/secrets.yaml
  - charts/pipeline-manager/templates/controller.yaml
  - charts/pipeline-manager/templates/secrets.yaml
  - charts/runtime-environment-manager/templates/controller.yaml
  - charts/runtime-environment-manager/templates/secrets.yaml
  - charts/tasker-kubernetes/templates/controller.yaml
  - charts/cf-broadcaster/templates/controller.yaml
  - charts/cf-broadcaster/templates/secrets.yaml
  - charts/cfsign/templates/cfsign-dpl.yaml
  - charts/cronus/templates/deployment.yaml
  - charts/cronus/templates/configmap.yaml
  - charts/hermes/templates/controller.yaml
  - charts/hermes/templates/configmap.yaml
  - charts/nomios/templates/deployment.yaml
  - charts/nomios/templates/configmap.yaml
  - charts/builder/templates/builder-ss.yaml
  - charts/builder/templates/builder-cm.yaml
  - charts/runner/templates/runner-ss.yaml
  - charts/runner/templates/runner-cm.yaml
  - charts/consul/templates/statefulset.yaml
  - charts/nats/templates/statefulset.yaml
  - charts/nats/templates/secrets.yaml
  - charts/rabbitmq/templates/statefulset.yaml
  - charts/rabbitmq/templates/config-secret.yaml
  - charts/rabbitmq/templates/secrets.yaml
  - charts/redis/templates/master/application.yaml
  - charts/redis/templates/configmap.yaml
  - charts/redis/templates/health-configmap.yaml
  - charts/redis/templates/scripts-configmap.yaml
  - charts/redis/templates/secret.yaml
  - charts/postgresql/templates/primary/statefulset.yaml
  - charts/mongodb/templates/standalone/dep-sts.yaml
  - charts/ingress-nginx/templates/controller-deployment.yaml
  - jobs/mongo-seed-job.yaml
  - jobs/certs-job.yaml
  - jobs/postgres-clean-cronjob.yaml
  - jobs/postgres-seed-job.yaml
  - hooks/update-default-runtimes.yaml
  - hooks/migrate-hermes-store.yaml
  - hooks/mongodb-migration-job.yaml
  - hooks/psql-migration-job.yaml
tests:
  - it: "(Codefresh charts) should test image private registry prefix"
    values:
      - ./values/private-registry.yaml
    asserts:
      # cf-api
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/cfapi/templates/controller.yaml
      # cf-ui
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/cfui/templates/deployment.yaml
      # charts-manager
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/charts-manager/templates/controller.yaml
      # cluster-providers
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/cluster-providers/templates/controller.yaml
      # context-manager
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/context-manager/templates/controller.yaml
      # gitops-dashboard-manager
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/gitops-dashboard-manager/templates/controller.yaml
      # helm-repo-manager
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/helm-repo-manager/templates/controller.yaml
      # k8s-monitor
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/k8s-monitor/templates/controller.yaml
      # kube-integration
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/kube-integration/templates/controller.yaml
      # pipeline-manager
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/pipeline-manager/templates/controller.yaml
      # runtime-environment-manager
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/runtime-environment-manager/templates/controller.yaml
      # tasker-kubernetes
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/tasker-kubernetes/templates/controller.yaml
      # cf-broadcaster
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/cf-broadcaster/templates/controller.yaml
      # cf-sign
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/cfsign/templates/cfsign-dpl.yaml
      # cronus
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/cronus/templates/deployment.yaml
      # hermes
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/hermes/templates/controller.yaml
      # nomios
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/codefresh/.*$
        template: charts/nomios/templates/deployment.yaml
      # cf-builder
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: charts/builder/templates/builder-ss.yaml
      # cf-runner
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: charts/runner/templates/runner-ss.yaml
  - it: "(Bitnami charts) should test image private registry prefix"
    values:
      - ./values/private-registry.yaml
    asserts:
      # bitnami consul
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/bitnami/.*$
        template: charts/consul/templates/statefulset.yaml
      # bitnami nats
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/bitnami/.*$
        template: charts/nats/templates/statefulset.yaml
      # bitnami rabbitmq
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/bitnami/.*$
        template: charts/rabbitmq/templates/statefulset.yaml
      # bitnami redis
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/bitnami/.*$
        template: charts/redis/templates/master/application.yaml
      # bitnami postgresql
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/bitnami/.*$
        template: charts/postgresql/templates/primary/statefulset.yaml
      # bitnami mongodb
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/bitnami/.*$
        template: charts/mongodb/templates/standalone/dep-sts.yaml
      # ingress-nginx
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: charts/ingress-nginx/templates/controller-deployment.yaml
  - it: "(Root chart) should test image private registry prefix"
    values:
      - ./values/private-registry.yaml
    asserts:
      # mongo-seed-job template
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: jobs/mongo-seed-job.yaml
      # certs-job template
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: jobs/certs-job.yaml
      # # postgres-seed-job template
      # - matchRegex:
      #     path: spec.template.spec.containers[0].image
      #     pattern: ^myregistry.io/.*$
      #   template: jobs/postgres-seed-job.yaml
      # update-default-runtimes template
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: hooks/update-default-runtimes.yaml
      # migrate-hermes-store template
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: hooks/migrate-hermes-store.yaml
      # postgres-clean-cronjob template
      - matchRegex:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          pattern: ^myregistry.io/.*$
        template: jobs/postgres-clean-cronjob.yaml
      # # mongodb-migration-job template
      # - matchRegex:
      #     path: spec.template.spec.containers[0].image
      #     pattern: ^myregistry.io/.*$
      #   template: hooks/mongodb-migration-job.yaml
      # # psql-migration-job template
      # - matchRegex:
      #     path: spec.template.spec.containers[0].image
      #     pattern: ^myregistry.io/.*$
      #   template: hooks/psql-migration-job.yaml
