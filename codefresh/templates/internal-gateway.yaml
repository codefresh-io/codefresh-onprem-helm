{{- if index .Values "argo-platform" "enabled" -}}

{{ $cfApiEndpointsSvc := (index .Subcharts "cfapi" ).Chart.Name }}
{{ $cfApiEndpointsPort := (index .Subcharts "cfapi" ).Values.service.main.ports.http.port }}
{{- if index .Values "cfapi-endpoints" "enabled" -}}
  {{ $cfApiEndpointsSvc = (index .Subcharts "cfapi-endpoints" ).Chart.Name }}
  {{ $cfApiEndpointsPort = (index .Subcharts "cfapi-endpoints" ).Values.service.main.ports.http.port }}
{{- end -}}

{{- $internalGatewayContext := (index .Subcharts "internal-gateway") }}
{{- $_ := set $internalGatewayContext.Values.codefresh "url" (coalesce .Values.global.appUrl $internalGatewayContext.Values.codefresh.url)  }}
{{- $_ := set $internalGatewayContext.Values.codefresh "cfApiEndpointsSvc" (printf "%s-%s.%s.svc.%s" .Release.Name $cfApiEndpointsSvc .Release.Namespace .Values.global.clusterDomain ) }}
{{- $_ := set $internalGatewayContext.Values.codefresh "cfApiEndpointsPort" $cfApiEndpointsPort }}
{{- $_ := set $internalGatewayContext.Values.codefresh "apiGraphqlSvc" (printf "%s.%s.svc.%s" $internalGatewayContext.Values.codefresh.apiGraphqlSvc .Release.Namespace .Values.global.clusterDomain ) }}
{{- $_ := set $internalGatewayContext.Values.codefresh "apiEventsSvc" (printf "%s.%s.svc.%s" $internalGatewayContext.Values.codefresh.apiEventsSvc .Release.Namespace .Values.global.clusterDomain ) }}
{{- $_ := set $internalGatewayContext.Values.codefresh "argoPlatformUiSvc" (printf "%s.%s.svc.%s" $internalGatewayContext.Values.codefresh.argoPlatformUiSvc .Release.Namespace .Values.global.clusterDomain ) }}

{{- if .Values.ingress.ingressClassName }}
{{- $_ := set $internalGatewayContext.Values.ingress.main "ingressClassName" .Values.ingress.ingressClassName }}
{{- end }}

{{- if .Values.ingress.tls.enabled }}
{{- $tlsObj := dict "secretName" (include "codefresh.ingress.tlsSecretName" .) "hosts" (list .Values.global.appUrl) }}
{{- $_ := set $internalGatewayContext.Values.ingress.main "tls" ( list $tlsObj ) }}
{{- end }}

{{- include "internal-gateway.resources" $internalGatewayContext }}

{{- end -}}