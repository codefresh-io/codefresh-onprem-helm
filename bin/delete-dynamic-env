#!/bin/bash

readonly basepath="$(dirname "$0")"
readonly keyfile="service-account.json"
source "$basepath/helpers"

usage() {
	echo "$0 [-h] namespace-name project-name cluster-name [zone]"
	exit 0
}

check kubectl
check aws

[ "$1" == "-h" ] && usage

readonly namespaceName="$1"
readonly projectName="${2:-savvy-badge-103912}"
readonly clusterName="${3:-cf-staging}"
readonly zone="${4:-us-central1-a}"

[ -z "$namespaceName" ] && err "Please specify the namespace name!"

[[ -z "$AWS_ACCESS_KEY_ID" || -z "$AWS_SECRET_ACCESS_KEY" ]] && err "Please set your AWS credentials"
[[ -z "$GOOGLE_SERVICE_ACCOUNT" ]] && err "Please set the service-account env var!"

# To encrypt the service account file use: `cat service-account.json | base64 -w 0`
msg "Decrypting the GOOGLE_SERVICE_ACCOUNT env variable"
echo "$GOOGLE_SERVICE_ACCOUNT" | base64 -d > $keyfile

msg "Logging in with the service account to google cloud and generating Kubernetes config"
gcloud config set container/cluster $clusterName
gcloud config set compute/zone $zone
gcloud config set project $projectName
gcloud auth activate-service-account --key-file $keyfile
gcloud container clusters get-credentials $clusterName

# set debug flag
if [ "$DEBUG_CHART" == "true" ]; then
  debug_flag="--debug"
fi

# set wait flag
WAIT=${WAIT:-true}
if [ "$WAIT" == "true" ]; then
  wait_flag="--wait"
fi

# set timeout flag
if [ ! -z "$TIMEOUT" ]; then
  timeout_flag="--timeout $TIMEOUT"
fi

# set dry run flag
if [ "$DRY_RUN" == "true" ]; then
  dry_run_flag="--dry-run"
fi

# get ingress public ip
publicIp=$(getIngressIp "$namespaceName")

msg "Delete the release using helm delete --purge"
helm delete --purge $dry_run_flag $wait_flag $debug_flag $timeout_flag $namespaceName

if [ "$DRY_RUN" == "true" ]; then
  msg "DRY_RUN delete: skip deleting routes and namespace"
else
  msg "Delete the namespace $namespaceName"
  kubectl delete namespace $namespaceName

  msg "Removing the environment from DNS..."
  deleteFromRoute53 "${namespaceName}.dev.codefresh.io" "$publicIp"
fi