---
version: '1.0'

steps:
  build:
    type: build
    image_name: codefresh/cf-env-creator

  init_helm:
    title: init helm client
    image: ${{build}}
    commands:
      - helm init --client-only
      - helm repo add chartmuseum-dev http://chartmuseum-dev.codefresh.io
      - helm repo add chartmuseum-stable http://chartmuseum.codefresh.io
  
  set_codefresh_repo:
    title: set codefresh chart repo to stable
    image: ${{build}}
    commands:
      - helm repo add codefresh http://chartmuseum.codefresh.io
      - if [ ! -z "$FORCE_HELM_REPO" ]; then helm repo add codefresh $FORCE_HELM_REPO; fi
    when:
      branch:
        only:
          - master

  set_codefresh_dev_repo:
    title: set codefresh chart repo to develop
    image: ${{build}}
    commands:
      - helm repo add codefresh http://chartmuseum-dev.codefresh.io
      - if [ ! -z "$FORCE_HELM_REPO" ]; then helm repo add codefresh $FORCE_HELM_REPO; fi
    when:
      branch:
        ignore:
          - master
  
  create_dynamic_env:
    title: create dynamic environment
    image: ${{build}}
    commands:
      - bash -c "bin/create-dynamic-env $NAMESPACE_NAME $PROJECT_NAME $CLUSTER_NAME $ZONE"

